---
title: 'Chapter 4: Stats'
author: "Andrew Flowers"
date: "3/6/2017"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

R is built to do stats. For my money, it's the best data analysis tool there is. But users commonly make mistakes doing statistics in R. Here are some and how to avoid them.

### Regressing when regressing

Regression analysis is a stable method for data science. In R, you'll often use the workhorse `lm()` function for doing linear regression and `glm()` for logistic regression and more advanced techniques. 

Let's load the `nba_elo_data.csv` data again and run some regress a team's elo rating at the start of a game (`elo_i`) against the point margin of their games (which we'll create by subracting `pts` from `opp_pts`). 

```{r cache = TRUE}
library(tidyverse)

# Load data
nba_elo_data <- read_csv("https://raw.githubusercontent.com/fivethirtyeight/data/master/nba-elo/nbaallelo.csv")

# Add new column, pts_margin, using the mutate() function
new_elo_data <- nba_elo_data %>% 
  mutate(pts_margin = pts - opp_pts)

lm(data = new_elo_data, formula = pts_margin ~ elo_i)
```


Not surprising: an NBA team's pre-game Elo rating is _positively_ associated with its margin of victory.

But the output, `elo_regression`, is hard to read, And it masks more detailed output from the regression.  We'll assign the `lm()` output (which is a model object) to the variable named `elo_regression`. Using the customary `summary()` function on the model object reveals more details -- but it's still hard to decipher.

```{r cache = TRUE}
elo_regression <- lm(data = new_elo_data, formula = pts_margin ~ elo_i)

# Printing the raw model output
elo_regression

# Printing the detailed model output 
summary(elo_regression)
```

Now let's actually use the regression output. A common beginner mistake is to make predictions from a regression by _directly_ accessing the model coefficients and then _manually_ calculcating the estimator (or "y-hat").

```{r cache = TRUE}

# Print regression coeficients
coef(elo_regression)

# BAD -- manually making a prediction
example_team_elo <- 1500
coef(elo_regression)[1] + (coef(elo_regression)[2] * example_team_elo)
```

This is a big no-no. It's far more simple -- and less error-prone -- to use the `predict()` function instead. Under this workflow, you provide `predict()` with two necessary inputs: (1) the model object you've generated from `lm()` and (2) a dataframe of new data to make predictions on (with the paramaeter name `newdata`). Here's a better way to make a prediction on the point margin of an NBA team with a 1500 Elo rating.

```{r cache = TRUE}

# Create data frame to use for predictions
new_data <- data.frame(elo_i = 1500)

# GOOD -- using the predict() function
predict(elo_regression, newdata = new_data)
```

### Use `broom` to tidy your model outpus

There is an even better workflow for cleaning working with R models -- especially when you're creating a lot of them at once. The wonderful package `broom`, by David Robinson, is here to save you. What `broom` does is simple by powerful: It stores model output data in a standardized data frame. 
